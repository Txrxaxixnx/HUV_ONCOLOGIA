# Analisis: `ui.py`

## Rol
- Interfaz grafica principal basada en `customtkinter`. Orquesta el procesamiento OCR, la escritura en SQLite, la visualizacion de datos y el dashboard analitico. Tambien expone la automatizacion Selenium del portal institucional.

## Estructura general
- Clase `App(CTk)` con tres zonas:
  - Header superior: titulo, meta y aspecto visual.
  - Barra lateral: botones para Procesar PDFs, Visualizar Datos, Dashboard Analitico, Automatizar BD Web y switch de tema.
  - Contenedor central: tarjetas KPI y vistas intercambiables.

## Estado clave
- `self.master_df`: DataFrame maestro con los registros leidos desde SQLite (fuente unica de verdad).
- `self.pdf_files`: lista de rutas seleccionadas para procesamiento.
- `self.db_filters`: diccionario con `StringVar` para filtros de dashboard (fecha desde/hasta, servicio, malignidad, responsable).
- `_dash_canvases`: lista de instancias `FigureCanvasTkAgg` para limpiar graficos al refrescar.
- `_compare_controls`: `StringVar` para el comparador dinamico del dashboard.

## Vista Procesar PDFs
- Botones: Seleccionar archivos, Procesar PDFs y controles de estado.
- Registro visual: `CTkTextbox` con log en tiempo real (timestamps).
- `start_processing` crea un hilo daemon que invoca `procesador_ihq_biomarcadores.process_ihq_paths`.
- Al finalizar, muestra dialogo de exito/error y actualiza KPIs/vista si procede.
- Logs usan `log_to_widget` y `_log_auto` para combinar mensajes del pipeline y Selenium.

## Vista Visualizar Datos
- Boton Actualizar recarga datos desde SQLite (`database_manager.get_all_records_as_dataframe`).
- Campo de busqueda filtra por numero de peticion, primer nombre o primer apellido.
- `ttk.Treeview` estilizado (filas cebra, sort en headers) muestra columnas clave y llama `mostrar_detalle_registro` al seleccionar una fila.
- Panel detalle `CTkTextbox` presenta todos los campos del registro.
- `_render_kpis` actualiza tarjetas (total registros, porcentaje de malignidad, ultima fecha, tiempo promedio).

## Vista Dashboard Analitico
- Sidebar opcional con filtros (fecha desde/hasta, servicio, malignidad, responsable); utilidades `_toggle_db_sidebar`, `_open_filters_sheet` y `_clear_filters`.
- Tabs: Overview, Biomarcadores, Tiempos, Calidad, Comparador.
- `_chart_in` encapsula la generacion de tarjetas con grafico Matplotlib y boton Pantalla completa.
- Graficos principales:
  - Overview: informes por mes, distribucion de malignidad, top servicios, top organos.
  - Biomarcadores: Ki-67, HER2, RE/RP, PD-L1.
  - Tiempos: boxplot tiempo de proceso, throughput semanal, dispersion edad vs Ki-67.
  - Calidad: porcentaje de campos vacios, productividad por responsable, longitud del diagnostico.
  - Comparador: barras por dimension con agregador conteo/promedio.
- Modo pantalla completa (`_open_fullscreen_figure`) abre `CTkToplevel` con grafico ampliado e inspector lateral (malignidad, top organos, rango de fechas).

## Automatizar BD Web
- Modal `CTkToplevel` pide usuario, clave, criterio y fechas (usa `CalendarioInteligente`).
- `_run_web_automation` se ejecuta en hilo daemon y llama `huv_web_automation.automatizar_entrega_resultados` (headless=False).
- Logs del bot se envian a la consola de procesamiento o al status bar.

## Integracion con SQLite
- `refresh_data_and_table` asegura la existencia de la base (`init_db`) y carga los registros.
- `database_manager.save_records` evita duplicados y controla el orden de columnas.
- Las vistas Visualizar/Dashboard trabajan sobre `self.master_df` para garantizar consistencia.

## Dependencias externas destacadas
- `customtkinter`, `ttkbootstrap`, `matplotlib`, `seaborn`, `pandas`, `numpy`, `selenium`, `webdriver-manager`.
- El estilo global se setea en modo oscuro con `ctk.set_appearance_mode('dark')`.

## Consideraciones y mejoras
- El procesamiento en hilo evita congelamientos, pero seria conveniente agregar boton Cancelar.
- Exportar CSV/Excel desde Visualizar datos facilitara entregas rapidas a investigadores.
- Agregar validaciones previas (Tesseract configurado, Chrome disponible) antes de iniciar procesos largos.
- Centralizar mensajes de error (OCR, Selenium, BD) en un panel unico con codigos de referencia.
